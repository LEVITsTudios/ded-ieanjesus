name: Run Database Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/supabase/cli/main/install.sh | sh
          supabase --version

      - name: Run migrations
        run: |
          export SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN }}
          export SUPABASE_DB_PASSWORD=${{ secrets.SUPABASE_DB_PASSWORD }}
          
          # Run SQL scripts (005, 006)
          psql "${{ secrets.SUPABASE_DB_URL }}" -f scripts/005_notifications_and_profiles.sql
          psql "${{ secrets.SUPABASE_DB_URL }}" -f scripts/006_push_subscriptions.sql

      - name: Trigger Vercel deployment
        run: |
          curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK_URL }} \
            -H 'Content-Type: application/json'
        if: ${{ secrets.VERCEL_DEPLOY_HOOK_URL != '' }}
